<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Extractor + Reproductor (m3u8/mp4)</title>

<!-- HLS.js -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<style>
  body { font-family: system-ui, -apple-system, Arial; padding: 18px; background:#f7f8fb; color:#102; }
  input[type=text]{ width:76%; padding:10px; border-radius:6px; border:1px solid #bbb; }
  button { padding:10px 14px; margin-left:8px; background:#2b4c7e; color:white; border:none; border-radius:6px; cursor:pointer; }
  #log{ margin-top:14px; white-space:pre-wrap; font-size:13px; color:#223; }
  #streams { margin-top:12px; }
  #streams div{ background:#fff; padding:8px; margin:6px 0; border-radius:6px; border-left:4px solid #2b4c7e; word-break:break-word; }
  #player { width:100%; max-width:900px; margin-top:18px; background:black; border-radius:10px; }
  .playbtn { margin-top:8px; padding:8px 12px; background:#2b4c7e; color:#fff; border:0; border-radius:6px; cursor:pointer; }
  .hint { font-size:13px; color:#606; margin-top:8px; }
</style>
</head>
<body>

<h2>Extractor de reproductor — intenta cargar el stream de la página</h2>

<p>1) Ingresa la URL de la página que contiene el reproductor (la página donde normalmente das Play)</p>
<input id="pageUrl" type="text" placeholder="https://ejemplo.com/pagina-con-player" />
<button id="btnSearch">Buscar & Cargar</button>

<div id="log"></div>

<h3>Streams detectados:</h3>
<div id="streams"></div>

<h3>Reproductor</h3>
<video id="player" controls></video>
<div id="autoplayHint" class="hint"></div>

<script>
const logEl = document.getElementById('log');
const streamsEl = document.getElementById('streams');
const player = document.getElementById('player');
const autoplayHint = document.getElementById('autoplayHint');

function log(...args){ logEl.innerText += args.join(' ') + '\n'; }

function reset() {
  logEl.innerText = '';
  streamsEl.innerHTML = '';
  player.src = '';
  autoplayHint.innerText = '';
}

document.getElementById('btnSearch').addEventListener('click', async () => {
  reset();
  const url = document.getElementById('pageUrl').value.trim();
  if(!url){ log('Introduce una URL válida'); return; }

  log('Usando proxy CORS para cargar la página (si falla, la página bloquea CORS):');
  log('https://corsproxy.io/?' + url);
  log('');

  try {
    // fetch via CORS proxy
    const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(url);
    log('Fetching: ' + proxyUrl);
    const res = await fetch(proxyUrl, {headers:{'Accept':'text/html'}});
    if(!res.ok){ throw new Error('HTTP ' + res.status); }
    const html = await res.text();
    log('HTML recibido — tamaño: ' + html.length + ' bytes');

    // attempt to extract obvious video sources
    const found = extractCandidates(html, url);
    if(found.length === 0){
      log('No se encontraron URLs directas en el HTML. Intentando buscar en scripts más complejos...');
      // run more heuristics
      const found2 = extractAdvanced(html, url);
      if(found2.length) found.push(...found2);
    }

    // remove duplicates
    const unique = [...new Set(found)];
    if(unique.length === 0){
      log('No se pudo encontrar ninguna URL de stream en el HTML estático.');
      log('POSIBLES CAUSAS:\n- La página genera la URL dinámicamente con JavaScript (XHR), por lo que necesitas un backend/headless (puppeteer) OR\n- La URL del stream está protegida y se genera tras interacción del usuario.\n\nOpciones:\n1) Abrir la página en una nueva pestaña y reproducir allí (si el site lo permite): window.open(url)\n2) Usar un servidor headless (puppeteer) para ejecutar la página y capturar las solicitudes de red.\n3) Si quieres, pega aquí la URL y yo intento detectar patrones concretos.');
      return;
    }

    log('Encontrado(s) ' + unique.length + ' candidato(s):');
    unique.forEach(u=>{
      const div = document.createElement('div');
      div.innerHTML = `<div>${u}</div>`;
      const btn = document.createElement('button');
      btn.className='playbtn';
      btn.innerText = '▶ Reproducir aquí';
      btn.onclick = () => reproducir(u);
      div.appendChild(btn);
      streamsEl.appendChild(div);
      log(' - ' + u);
    });

    // autoplay first
    reproducir(unique[0]);

  } catch(err){
    log('Error al cargar la página: ' + err.message);
    log('Intenta abrir la página directa en otra pestaña: window.open("' + url + '")');
  }
});

// heuristics: simple regex searches in HTML
function extractCandidates(html, baseUrl){
  const results = [];
  // common direct urls: .m3u8, .mp4, .ts, .webm, .mkv
  const reFile = /(https?:\/\/[^"'<> \n\r]+?\.(m3u8|mp4|ts|webm|mkv|flv|avi)(?:\?[^"'<> ]*)?)/ig;
  let m;
  while((m = reFile.exec(html)) !== null){
    results.push(m[1]);
  }
  // attributes like data-src="/stream/abc.m3u8" or src="/..."; resolve relative paths
  const reAttr = /(?:src|data-src|data-hls|data-file|data-url)\s*=\s*["']([^"']+)["']/ig;
  while((m = reAttr.exec(html)) !== null){
    const candidate = resolveUrl(baseUrl, m[1]);
    if(candidate) results.push(candidate);
  }

  // players config inside scripts JSON: look for "file": "..." or file: "..."
  const reJsonFile = /["']file["']\s*:\s*["']([^"']+\.(m3u8|mp4)[^"']*)["']/ig;
  while((m = reJsonFile.exec(html)) !== null){
    results.push(resolveUrl(baseUrl, m[1]));
  }

  // jwplayer style: sources: [{file:"..."}]
  const reJW = /file\s*:\s*["']([^"']+\.(m3u8|mp4)[^"']*)["']/ig;
  while((m = reJW.exec(html)) !== null){
    results.push(resolveUrl(baseUrl, m[1]));
  }

  return results.filter(Boolean);
}

// advanced: look for base64 JSON blobs, URLs inside long JS objects, or keys like "hls","playlist"
function extractAdvanced(html, baseUrl){
  const results = [];
  // find JSON-looking strings and search for .m3u8 inside them
  const reScripts = /<script\b[^>]*>([\s\S]*?)<\/script>/ig;
  let s;
  while((s = reScripts.exec(html)) !== null){
    const scriptText = s[1];
    // search for any .m3u8 inside script text
    const reAny = /(https?:\/\/[^"'<> \n\r]+?\.m3u8[^"'<> ]*)/ig;
    let mm;
    while((mm = reAny.exec(scriptText)) !== null){
      results.push(mm[1]);
    }
    // search for quoted relative paths inside script vars
    const reRel = /["']([^"']+?\.(m3u8|mp4|ts|webm|mkv|flv|avi)[^"']*)["']/ig;
    while((mm = reRel.exec(scriptText)) !== null){
      results.push(resolveUrl(baseUrl, mm[1]));
    }
    // look for base64-encoded JSON
    const reBase64 = /"(?:[A-Za-z0-9+/]{40,}={0,2})"/g;
    let b;
    while((b = reBase64.exec(scriptText)) !== null){
      try {
        const decoded = atob(b[0].slice(1,-1));
        const r2 = /(https?:\/\/[^"'<> \n\r]+?\.m3u8[^"'<> ]*)/ig;
        let r;
        while((r = r2.exec(decoded)) !== null) results.push(r[1]);
      } catch(e){}
    }
  }
  return results.filter(Boolean);
}

// resolve relative URL using base
function resolveUrl(base, maybeRelative){
  try{
    if(/^https?:\/\//i.test(maybeRelative)) return maybeRelative;
    // handle protocol-relative
    if(maybeRelative.startsWith('//')){
      const proto = (new URL(base)).protocol;
      return proto + maybeRelative;
    }
    const resolved = new URL(maybeRelative, base).toString();
    return resolved;
  } catch(e){
    return null;
  }
}

// reproducir con HLS.js si aplica y con autofallback de boton si autoplay bloquea
async function reproducir(url){
  autoplayHint.innerText = '';
  player.pause();
  // remove existing Hls instances if any (simple approach: reload video element)
  player.src = '';
  player.muted = true; // try muted autoplay

  if(url.endsWith('.m3u8') || url.includes('.m3u8?') ){
    if(Hls.isSupported()){
      try {
        const hls = new Hls();
        hls.loadSource(url);
        hls.attachMedia(player);
      } catch(err){
        log('HLS.js error: ' + err);
      }
    } else if(player.canPlayType('application/vnd.apple.mpegurl')){
      player.src = url;
    }
  } else {
    // mp4, ts, webm etc
    player.src = url;
  }

  // try autoplay
  try {
    await player.play();
    log('Reproduciendo automáticamente (muteado). Si quieres sonido, pulsa play y desactiva mute.');
  } catch (e){
    log('Autoplay bloqueado → mostrando botón para iniciar (reproduce con sonido al pulsar).');
    showPlayOverlay(player);
  }
}

// show play overlay/button below player
function showPlayOverlay(videoEl){
  // remove existing
  const existing = document.getElementById('__play_overlay_btn');
  if(existing) existing.remove();

  const btn = document.createElement('button');
  btn.id = '__play_overlay_btn';
  btn.className = 'playbtn';
  btn.textContent = '▶ Iniciar reproducción';
  btn.onclick = async () => {
    videoEl.muted = false;
    try{ await videoEl.play(); }catch(e){ console.error(e); }
    btn.remove();
  };
  videoEl.insertAdjacentElement('afterend', btn);
}

</script>
</body>
</html>
